
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        How to Tell if TCP Payloads Are Identical - 
      
      Unroutable
    </title>
    
    <meta name="author" content="Jay Swan">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">Unroutable</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/jayswan" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/sanjuanswan" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    How to Tell if TCP Payloads Are Identical 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <span style="font-family: inherit;">I was working on a problem today in which vendor tech support was suggesting that a firewall was subtly modifying TCP data payloads. I couldn't find any suggestion of this in the firewall logs, but seeing as how I've seen that vendor's firewall logs lie egregiously in the past, I wanted to verify it independently.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">I took a packet capture from both hosts involved in the conversation and started thinking about how to see if the data sent by the server was the same as the data received by the client. I couldn't just compare the capture files themselves, because elements like timestamps, TTLs, and IP checksums would be different.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">After a bunch of fiddling around, I came up with the idea of using tshark to extract the TCP payloads for each stream in the capture file and hash the results. If the hashes matched, the TCP payloads were being transferred unmodified. Here are the shell commands to do this:</span><br /><br /><span style="font-family: Courier New, Courier, monospace;">tshark -r server.pcap -T fields -e tcp.stream | sort -u | sed 's/\r//' |&nbsp;xargs -i tshark -r server.pcap -q -z follow,tcp,raw,{} | md5sum</span><br /><span style="font-family: Courier New, Courier, monospace;">2cfe2dbb5f6220f29ff8aff82f7f68f5 *-</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: inherit;">You then run exactly the same commands on the "client.pcap" file and compare the resulting hashes. Let's break this down a bit more:</span><br /><span style="font-family: inherit; font-size: x-small;"><br /></span><span style="font-family: 'Courier New', Courier, monospace;">tshark -r server.pcap -T fields -e tcp.stream</span><br /><br />This invokes tshark to read the "server.pcap" file and output the TCP stream indexes of each packet. This is just a long series of integers:<br /><span style="font-size: x-small;"><br /></span>0<br />0<br />1<br />2<br />1<br />etc.<br /><span style="font-size: x-small;"><br /></span>The next command, <span style="font-family: Courier New, Courier, monospace;">sort -u</span>, produces a logical set of the unique (hence the "-u") stream indexes. In other words, it removes duplicates from the previous list. Not all Unix-like operating systems have the "<span style="font-family: Courier New, Courier, monospace;">sort -u</span>" option; if yours is missing it, you can use "<span style="font-family: Courier New, Courier, monospace;">| sort | uniq</span>" instead.<br /><br />Next,<span style="font-family: Courier New, Courier, monospace;"> sed 's/\r//'</span> removes the line break from the end of the resulting stream indexes. If you don't do this, you'll get an error from the next command.<br /><span style="font-size: x-small;"><br /></span>The next one's a bit of a doozy: <span style="font-family: Courier New, Courier, monospace;">xargs -i</span>&nbsp;takes each stream index (remember, these are just integers) and executes the&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">tshark -r server.pcap -q -z follow,tcp,raw,{}</span>command once for each stream index, substituting the input stream index for the {} characters.<br /><br />The&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">tshark -r server.pcap -q -z follow,tcp,raw,{} </span><span style="font-family: inherit;">command itself reads the capture file a second time, running the familiar "Follow TCP Stream in Raw Format" command from Wireshark on the specified TCP stream index that replaces the {} characters. If you're rusty on Wireshark, "Follow TCP Stream" just dumps the TCP payload data in one of a variety of formats, such as "raw" or ASCII. If you've never used this option in Wireshark, make sure you try it today!</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">The final command, </span><span style="font-family: Courier New, Courier, monospace;">md5sum</span><span style="font-family: inherit;">, runs a MD5 hash on the preceding input.</span><br /><span style="font-family: inherit;"><br /></span>To summarize, we've done this: taken a file, extracted all the raw TCP data payloads from its packets (without headers), and hashed the data with MD5. If we do this on two files and the hashes are the same, we know they contain exactly the same TCP data (barring the infinitesimally small probability of a MD5 hash collision).<br /><br />In my case, both capture files produced the same hash, proving that the firewall was (for once) playing nice.
    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/2013/10/16/java-is-to-javascript-as-car-is-to" title="Java is to JavaScript as Car is to Carpet - a Beginner's Guide">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/2013/11/08/handy-tshark-expressions" title="Handy Tshark Expressions">Next &rarr;</a>
      
    </div>
    <hr>
    
  </div>
  
  <div class="span4">
    <section>
      <h4>Published</h4>
      <div class="date"><span>01 November 2013</span></div>
           
    </section>
    
      <section>
        <h4>Categories</h4>
        
      </section>
         
             
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2015 Jay Swan
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    



  </body>
</html>

