---
layout: post
title: playing with VLAN-based QoS
date: '2010-11-18T07:58:00.004-07:00'
author: Jay Swan
tags: 
modified_time: '2010-11-18T08:47:18.621-07:00'
blogger_id: tag:blogger.com,1999:blog-5029689981158113588.post-1605595333805960171
blogger_orig_url: http://unroutable.blogspot.com/2010/11/playing-with-vlan-based-qos.html
---

A friend of mine brought up an interesting question yesterday:<br /><br />Will the "mls qos vlan-based" command mark packets if the packets aren't routed by the SVI where the service policy is applied?<br /><br />I had never even considered this before, so I guessed "no" before reading the docs. Then I set it up in the lab, and the answer (superficially) still seemed to be "no". Then, however, I executed the old RTFM maneuver: the docs made it sound like the answer should be "yes". So I thought I'd have a closer look. Here are the details.<br /><br />The test topology looks like this:<br /><br /><span style="font-weight: bold;">R5---Switch1---Switch2---Cat3750---R6</span><br /><br /><ul><li>R5 &amp; R6 are 2800 series routers.</li><li>Switch1 and Switch2 are 3560s.</li><li>Cat3750, unsurprisingly, is a Catalyst 3750, and the subject of the test.</li></ul><br />All of the inter-switch links are 802.1q trunks, and the two routers are connected to access ports in VLAN 6.<br /><br /><ul><li>R5's interface IP address is 10.6.6.5, with a loopback of 5.5.5.5.</li><li>R6's interface IP address is 10.6.6.6, with a loopback of 6.6.6.6.</li><li>R5 and R6 are running OSPF on all interfaces and are neighbors when the test begins.</li></ul><br />First, I set up a QoS policy on the 3750 that would make packets distinguishable from each other:<br /><br /><span style="font-size:85%;"><span style="font-family:courier new;">ip access-list extended ALL</span><br /><span style="font-family:courier new;"> permit ip any any</span><br /><span style="font-family:courier new;">!</span><br /><span style="font-family:courier new;">class-map match-any FOO</span><br /><span style="font-family:courier new;"> match access-group name ALL</span><br /><span style="font-family:courier new;">!</span><br /><span style="font-family:courier new;">policy-map IN-MARKING</span><br /><span style="font-family:courier new;"> class FOO</span><br /><span style="font-family:courier new;">  set ip dscp cs2</span><br /><span style="font-family:courier new;"> class class-default</span><br /><span style="font-family:courier new;">  set dscp cs1</span></span><br /><br />Then I applied the policy-map to an unrouted SVI for VLAN 6:<br /><br /><span style=";font-family:courier new;font-size:85%;"  >interface Vlan6<br />no ip address<br />service-policy input IN-MARKING</span><br /><br />Then I set R6's access port for VLAN-based QoS:<br /><br /><span style=";font-family:courier new;font-size:85%;"  >interface FastEthernet1/0/2<br />switchport access vlan 6<br />switchport mode access<br />mls qos vlan-based<br />spanning-tree portfast</span><br /><br />Since all traffic should be marked as CS2, the OSPF hello packets being exchanged between R5 and R6 should get marked immediately if the policy is working, but I also generated some ICMP and telnet traffic just for good measure.<br /><br />My superficial, pre-RTFM diagnosis, said it wasn't working:<br /><br /><span style=";font-family:courier new;font-size:85%;"  >c3750#sh policy-map interface<br />Vlan6<br /><br />Service-policy input: IN-MARKING<br /><br />  Class-map: FOO (match-any)<br />    0 packets, 0 bytes<br />    5 minute offered rate 0 bps, drop rate 0 bps<br />    Match: access-group name ALL<br />      0 packets, 0 bytes<br />      5 minute rate 0 bps<br /><br />  Class-map: class-default (match-any)<br />    0 packets, 0 bytes<br />    5 minute offered rate 0 bps, drop rate 0 bps<br />    Match: any<br />      0 packets, 0 bytes<br />      5 minute rate 0 bps</span><br /><br />After my RTFM episode, I started wondering if the packets were getting marked anyway, but not counted by the switch. Idecided to try applying a service policy on R5 that would have rather dramatic effects if the packets were in fact marked:<br /><span style="font-size:85%;"><br /><span style="font-family:courier new;">class-map match-any CM_CS2</span><br /><span style="font-family:courier new;"> match ip dscp cs2</span><br /><span style="font-family:courier new;">!</span><br /><span style="font-family:courier new;">policy-map PM_DROP_CS2</span><br /><span style="font-family:courier new;"> class CM_CS2</span><br /><span style="font-family:courier new;">   drop</span></span><br /><br />then...<br /><span style="font-size:85%;"><br /><span style="font-family:courier new;">R5(config)#int f0/0</span><br /><span style="font-family:courier new;">R5(config-if)#service-policy input PM_DROP_CS2</span><br /><span style="font-family:courier new;">R5(config-if)#</span><br /><span style="font-family:courier new;">R5(config-if)#</span><br /><span style="font-family:courier new;">*Nov 18 15:37:18.097: %OSPF-5-ADJCHG: Process 1, Nbr 20.1.1.6 on FastEthernet0/0 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br /><br /><span style="font-family:courier new;">R5#sh policy-map interface f0/0 input class CM_CS2</span><br /><span style="font-family:courier new;"> FastEthernet0/0</span><br /><br /><span style="font-family:courier new;">  Service-policy input: PM_DROP_CS2</span><br /><br /><span style="font-family:courier new;">    Class-map: CM_CS2 (match-any)</span><br /><span style="font-family:courier new;">      20 packets, 1880 bytes</span><br /><span style="font-family:courier new;">      5 minute offered rate 0 bps, drop rate 0 bps</span><br /><span style="font-family:courier new;">      Match: ip dscp cs2 (16)</span><br /><span style="font-family:courier new;">        20 packets, 1880 bytes</span><br /><span style="font-family:courier new;">        5 minute rate 0 bps</span><br /><span style="font-family:courier new;">      drop</span><br /></span><br />So... in conclusion: the "mls qos vlan-based" command does indeed work for service policies applied to interfaces that don't route packets for the VLAN... essentially, the command causes the access port to inherit the QoS policy applied to the SVI, and the SVI doesn't count them. This does actually make sense, but it took working through the lab to make my brain process it correctly.