---
layout: post
title: Zone Based Firewall Configuration Example
date: '2011-06-10T10:33:00.002-06:00'
author: Jay Swan
tags: 
modified_time: '2011-06-10T10:39:04.670-06:00'
blogger_id: tag:blogger.com,1999:blog-5029689981158113588.post-297229545304087617
blogger_orig_url: http://unroutable.blogspot.com/2011/06/zone-based-firewall-configuration.html
---

<div style="font-family: Arial,Helvetica,sans-serif;"><span id="internal-source-marker_0.33678132530079186" style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">There  aren’t a ton of examples available for IOS Zone-Based Firewall  configurations, so I thought I’d put up one with which I’ve been working  recently.</span></div><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: small;"><br /></span></div><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: small;">My test network looks like this:</span></div><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: small;"><br /></span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R4 ------------------- R5 ----------------------- R6</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;"><br /></span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R4 Loopback: 4.4.4.4</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R4 to R5 link: 1.1.45.0/24 </span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R5 Loopback: 5.5.5.5</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R5 to R6 link: 1.1.56.0/24 </span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">R6 Loopback: 6.6.6.6</span></div><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: small;"><br /></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">My goal is to express this policy:</span></div><ol style="font-family: Arial,Helvetica,sans-serif;"><li style="font-family: Arial,Helvetica,sans-serif;"><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Hosts in group X on the OUTSIDE network can initiate sessions to hosts  on the INSIDE network. Return traffic for those sessions should be  statefully permitted.</span><span style="font-size: small;"> In the lab, group X is represented by R4's loopback address.</span></li><li><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Any host on the INSIDE network can initiate sessions to hosts in group X  on the OUTSIDE network. Return traffic for those sessions should be  statefully permitted.</span><span style="font-size: small;"> In the lab, the inside hosts are represented by R6's loopback address.</span></li><li><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp;Permitted traffic should be logged. All other traffic should be dropped and logged.</span></li></ol><div style="font-family: Arial,Helvetica,sans-serif;"><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">The  network on which the production version of this lab test will be  deployed currently uses extended access-lists to implement the policy.  Access-lists have the advantage of being familiar to anyone with a basic  knowledge of IOS, but they have a lot of disadvantages:</span></div><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: small;"><br /></span></div><ol style="font-family: Arial,Helvetica,sans-serif;"><li><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Hard to read and troubleshoot as they grow.</span><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp;</span></li><li><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">No stateful awareness. Trying to retrofit statefulness onto extended  ACLs to allow return traffic requires ugly hacks with source port  restrictions, filtering on ACK bits, etc. This path eventually leads to  mind-numbing troubleshooting problems, and is less than optimal in its  security.</span><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp;</span></li><li><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Extended ACLs don’t have application-layer awareness.</span></li></ol><div style="font-family: Arial,Helvetica,sans-serif;"><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">There  are several tools in IOS to facilitate stateful traffic inspection, but  Zone-Based Firewalls are the newest and most flexible, so it made sense  to use them.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Most  of the examples I found via Google show the simple case of inside hosts  having unfettered access to the outside, and outside hosts having no  access to the inside--a classic stateful firewall design. My case is  only slightly more complex, but it still took me a couple of tries to  make it work.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">First,  I built access-lists defining the traffic to be allowed. I decided to  use the relatively new IOS object-group support to make it easier to add  and delete hosts on the respective networks:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">object-group network OG_INSIDE_HOSTS</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; host 6.6.6.6</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">object-group network OG_OUTSIDE_ALLOWED</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; host 4.4.4.4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">ip access-list extended INSIDE_TO_OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; permit ip object-group OG_INSIDE_HOSTS object-group OG_OUTSIDE_ALLOWED</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">ip access-list extended OUTSIDE_TO_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; permit ip object-group OG_OUTSIDE_ALLOWED object-group OG_INSIDE_HOSTS</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">You  might notice that there’s no “deny ip any any log” statement in these  ACLs, which is strange given requirement #3 above. It turns out that  when using ZBFW, you configure drop logging elsewhere; I’ll cover that  below.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">I  couldn’t find a way to express protocol inspection policy and IPv4  address policy in the same class-map, so I had to use a hierarchical  configuration. To express the protocol inspection policy, I built a  class-map to define the layer 4 protocols that will be inspected by the  firewall:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">class-map type inspect match-any CM_INSPECTED_PROTOCOLS</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match protocol icmp</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match protocol tcp</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match protocol udp</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">This  class-map does simple generic TCP/UDP/ICMP inspection, but it could  easily be extended or rewritten to use much more complex inspection  rules.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Next, I built class-maps for each direction that match the appropriate ACL and the inspection policy configured above:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">class-map type inspect match-all CM_OUTSIDE_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match access-group name OUTSIDE_TO_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match class-map CM_INSPECTED_PROTOCOLS</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">class-map type inspect match-all CM_INSIDE_OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match access-group name INSIDE_TO_OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; match class-map CM_INSPECTED_PROTOCOLS</span><br /><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">To  meet the packet permit-log requirement, we need a “parameter-map” that  will be applied in the policy-map that references the previous  class-maps:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">parameter-map type inspect PARAM_AUDIT_LOG</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; audit-trail on</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Next, the class-maps and parameter-map are referenced in a pair of policy-maps:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">policy-map type inspect PM_ZBFW_OUTSIDE_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; class type inspect CM_OUTSIDE_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"> &nbsp;&nbsp;&nbsp; inspect PARAM_AUDIT_LOG</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; class class-default</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"> &nbsp;&nbsp;&nbsp; drop log</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">policy-map type inspect PM_ZBFW_INSIDE_OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; class type inspect CM_INSIDE_OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"> &nbsp;&nbsp;&nbsp; inspect PARAM_AUDIT_LOG</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; class class-default</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"> &nbsp;&nbsp;&nbsp; drop log</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Note  the “drop log” statement in the final section. Similar to the implicit  deny rule in ACLs, ZBFW policies include a class-default with a drop  statement. If you want packet drops to be logged, however, you need to  explicitly add the “log” parameter to the drop command.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">At  this point, the policies are configured. Now they need to be linked to  interfaces and traffic direction. This is where the “zones” come in:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">zone security INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; description to R6</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">zone security OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; description to R4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">interface FastEthernet0/0</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; zone-member security OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">interface FastEthernet0/1</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; zone-member security INSIDE</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Finally, I created zone pairs that associate zones, traffic direction, and traffic policy:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">zone-pair security ZP_OUTSIDE_INSIDE source OUTSIDE destination INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; service-policy type inspect PM_ZBFW_OUTSIDE_INSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">zone-pair security ZP_INSIDE_OUTSIDE source INSIDE destination OUTSIDE</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">&nbsp; service-policy type inspect PM_ZBFW_INSIDE_OUTSIDE</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">At  this point, the zone-based firewall should be working and ready to  test. Based on the policy defined above, traffic from R4’s loopback  address should be able to reach R6’s loopback address, but traffic from  other interfaces on R4 should be dropped:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">R4#ping 6.6.6.6 source 4.4.4.4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Type escape sequence to abort.</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Packet sent with a source address of 4.4.4.4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">!!!!!</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/2/4 ms</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">R4#</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">R4#ping 6.6.6.6 source 1.1.45.4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Type escape sequence to abort.</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Packet sent with a source address of 1.1.45.4</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">.....</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">Success rate is 0 percent (0/5)</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">So far, this looks good. The log on R5 should verify the results above:</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">*Jun  10 14:29:02.604: %FW-6-SESS_AUDIT_TRAIL_START:  (target:class)-(ZP_OUTSIDE_INSIDE:CM_OUTSIDE_INSIDE):Start icmp session:  initiator (4.4.4.4:0) -- responder (6.6.6.6:0)</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">*Jun 10 14:29:13.100: %FW-6-SESS_AUDIT_TRAIL: (target:class)-(ZP_OUTSIDE_INSIDE:CM_OUTSIDE_INSIDE):Stop icmp session: in</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">itiator (4.4.4.4:8) sent 360 bytes -- responder (6.6.6.6:0) sent 360 bytes</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">*Jun  10 14:29:16.420: %FW-6-DROP_PKT: Dropping icmp session 1.1.45.4:0  6.6.6.6:0 on zone-pair ZP_OUTSIDE_INSIDE class class-default due to  &nbsp;DROP action found in policy-map with ip ident 0</span><br /><span style="background-color: transparent; color: black; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">*Jun  10 14:29:19.812: %FW-6-LOG_SUMMARY: 2 packets were dropped from  1.1.45.4:8 =&gt; 6.6.6.6:0  (target:class)-(ZP_OUTSIDE_INSIDE:class-default)</span><br /><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">The  first two lines show the permitted session; the second pair of lines  show the dropped session. I haven’t had the chance yet to examine log  entries for traffic types other than TCP/UDP/ICMP, but at first glance  it looks like the log entries are formatted in a way that’s friendly to  machine parsing.</span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;"></span><br /><span style="background-color: transparent; color: black; font-size: small; font-style: normal; font-weight: normal; text-decoration: none; vertical-align: baseline;">My  next step should probably be to get the Cisco Press <a href="http://www.ciscopress.com/bookstore/product.asp?isbn=1587053101">eBook on ZBFW</a> by  the formidable <a href="http://blog.ioshints.info/">Ivan Pepelnjak</a>, which I’m a little embarassed about not  having read.</span></div>