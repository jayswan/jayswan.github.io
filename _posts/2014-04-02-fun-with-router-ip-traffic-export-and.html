---
layout: post
title: Fun with Router IP Traffic Export and NSM
date: '2014-04-02T09:54:00.001-06:00'
author: Jay Swan
tags: 
modified_time: '2014-04-02T09:54:03.981-06:00'
thumbnail: http://1.bp.blogspot.com/-m46uHdW4ROg/Uzsrvbx5yrI/AAAAAAAAAEM/jd8x3WpHfxg/s72-c/lab.png
blogger_id: tag:blogger.com,1999:blog-5029689981158113588.post-1113081543398393796
blogger_orig_url: http://unroutable.blogspot.com/2014/04/fun-with-router-ip-traffic-export-and.html
---

<i><span style="font-size: large;">The Basics </span></i><br />I finally got around to setting up <a href="http://blog.securityonion.net/" target="_blank">Security Onion</a> (the best network security monitoring package available) to monitor my home network, only to discover that my Cisco 891 router doesn't support support the right form of SPAN. Here's how I worked around it. The topology looks like this:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-m46uHdW4ROg/Uzsrvbx5yrI/AAAAAAAAAEM/jd8x3WpHfxg/s1600/lab.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-m46uHdW4ROg/Uzsrvbx5yrI/AAAAAAAAAEM/jd8x3WpHfxg/s1600/lab.png" height="328" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The 891 router has an integrated 8-port switch module, so the simple case would have been a traditional SPAN setup; something like this:<br /><span style="font-size: small;"><br /></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">! vlan 10 is the user VLAN</span> </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small;">monitor session 1 source interface vlan 10 <!------></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: small;">monitor session 1 destination interface FastEthernet0</span><br /><br />with the server's monitoring NIC connected to FastEthernet0.<br /><br />The problem is that the 891 doesn't support using a VLAN as a source interface, and because of the way the embedded WAP works, a physical source interface won't work either. Hence, I turned to an obscure feature that's helped me occasionally in the past: <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/sec_usr_cfg/configuration/15-mt/sec-usr-cfg-15-mt-book/sec-ip-traff-export.html" target="_blank">Router IP Traffic Export</a>. This is a feature for IOS software platforms that enables you to enable SPAN-like functions for almost any source interface.<br /><br />The configuration looks like this:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ip traffic-export profile RITE_MIRROR<br />&nbsp; interface FastEthernet0<br />&nbsp; bidirectional<br />&nbsp; mac-address 6805.ca21.2ddd</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">interface Vlan10</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;ip traffic-export apply RITE_MIRROR</span><br /><br />This takes all traffic routed across the Vlan10 SVI and sends it out the FastEthernet0 interface, rewriting the destination MAC address to the specified value. I used the MAC address of my monitoring NIC, but it shouldn't matter in this case because the monitoring NIC is directly attached. If I wanted to copy the traffic across a switched interface, it would matter.<br /><br />My ESXi host (a low-cost machine from <a href="https://zareason.com/" target="_blank">Zareason</a> with 32GB of RAM) has two physical NICs; one for all of the regular VM traffic (using 802.1q to separate VLANs if needed) and one for monitoring. The monitoring pNIC is attached to a promiscuous mode vSwitch in ESXi, which in turn is connected to the monitoring vNIC on the Security Onion VM. The effect of this is identical to SPAN-ing all the traffic from VLAN 10 to my Security Onion monitoring system; I get Snort, Bro, Argus, and full packet capture with just the built-in software tools in IOS and ESXi.<br /><br /><span style="font-size: large;"><i>Oddity: RITE Capture, Tunnels?</i></span><br />Interestingly, you can also use RITE to <a href="http://www.cisco.com/c/en/us/td/docs/ios/12_4t/12_4t11/ht_rawip.html#wp1051438" target="_blank">capture traffic to a RAM buffer and export it to a pcap file</a>. I don't understand why you would use this instead of the much more flexible <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/epc/configuration/15-mt/epc-15-mt-book/nm-packet-capture.html" target="_blank">Embedded Packet Capture Feature</a>, though.<br /><br />Another thing I've wondered is whether you could use a L2 tunnel to send the mirrored traffic elsewhere in the network. The destination interface must be a physical Ethernet interface, but it would be interesting to try using a L2TPv3 tunnel from an Ethernet interface to another router--I have no idea if this would work. <br /><br /><i><span style="font-size: large;">Production Use?</span></i><br />Cisco makes the <a href="http://www.cisco.com/c/dam/en/us/products/collateral/servers-unified-computing/ucs-e-series-servers/data_sheet_c78-705787.pdf" target="_blank">UCS E-series blades</a> for ISR G2 routers that let you run a hypervisor on a blade inside your router chassis. These things have an external Ethernet port on them, so you should be able to connect a RITE export interface to the external port on an E-series blade, and run Security Onion inside your router. I've always wanted to try this, but I haven't been able to get funding yet to test it.