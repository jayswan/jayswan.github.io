
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        Encrypted GRE Tunnel with ASA for Encryption Offload - 
      
      Unroutable
    </title>
    
    <meta name="author" content="Jay Swan">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">Unroutable</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/jayswan" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/sanjuanswan" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    Encrypted GRE Tunnel with ASA for Encryption Offload 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    I have a requirement to connect two internal routers over a high-speed, 3rd party, non-Internet network.  The two routers need to run EIGRP with each other. We want to encrypt the link, but the routers don't support IPSec in their current configuration. Purchasing IPSec acceleration hardware for them is expensive, but we happen to have two ASAs in inventory that aren't currently in production.<br /><br />The simplest solution for this is to connect the two routers with a GRE tunnel, then use the ASAs to encrypt the GRE traffic.<br /><br />While I've worked with ASAs quite a bit as stateful packet filters and as remote access VPN headends, it's been a really long time since I've used one in a point-to-point VPN. I thought I'd blog about the lab proof-of-concept so that I don't forget everything about the configuration.<br /><br />My lab topology looks like this:<br /><br />R4---ASA1---ASA2---R5<br /><br />R4 and R5 have a standard GRE tunnel configured between them, running EIGRP to advertise their loopbacks. The tunnel destination is statically routed.<br /><br />On R4:<br /><br /><span style="font-family:courier new;">interface Loopback0</span> <span style="font-family:courier new;"><br /> ip address 4.4.4.4 255.255.255.0</span> <span style="font-family:courier new;"><br />!<br /></span><span style="font-family:courier new;">interface FastEthernet0/0<br /></span> <span style="font-family:courier new;"> description link to ASA1</span> <span style="font-family:courier new;"><br /> ip address 1.1.1.4 255.255.255.0</span> <span style="font-family:courier new;"><br />!<br /></span><span style="font-family:courier new;">interface Tunnel50</span> <span style="font-family:courier new;"><br /> description GRE tunnel to R5, will be encrypted by ASA1</span> <span style="font-family:courier new;"><br /> ip address 50.1.1.4 255.255.255.0<br /> </span> <span style="font-family:courier new;">tunnel source FastEthernet0/0</span><br />   <span style="font-family:courier new;">tunnel destination 2.2.2.5</span> <span style="font-family:courier new;"><br />!</span><br /><span style="font-family:courier new;">ip route 2.2.2.5 255.255.255.255 1.1.1.1</span> <span style="font-family:courier new;"><br />!</span><br /><span style="font-family:courier new;">router eigrp 1</span> <span style="font-family:courier new;"><br />network 4.0.0.0</span> <span style="font-family:courier new;"><br />network 50.1.1.0 0.0.0.255</span><br /><br />On R5:<br /><br /><span style="font-family:courier new;">interface Loopback0</span> <span style="font-family:courier new;"><br />ip address 5.5.5.5 255.255.255.0</span><br /><span style="font-family:courier new;">!</span> <span style="font-family:courier new;"><br />interface FastEthernet0/0</span> <span style="font-family:courier new;"><br />description link to ASA2</span> <span style="font-family:courier new;"><br />ip address 2.2.2.5 255.255.255.0</span> <span style="font-family:courier new;"><br />!</span> <span style="font-family:courier new;"><br />interface Tunnel50</span> <span style="font-family:courier new;"><br />description GRE tunnel to R4, will be encrypted by ASA2</span><br /><span style="font-family:courier new;"> ip address 50.1.1.5 255.255.255.0</span> <span style="font-family:courier new;"><br />tunnel source FastEthernet0/0</span><br /><span style="font-family:courier new;"> tunnel destination 1.1.1.4</span> <span style="font-family:courier new;"><br />!</span> <span style="font-family:courier new;"><br />router eigrp 1</span> <span style="font-family:courier new;"><br />network 5.0.0.0</span> <span style="font-family:courier new;"><br />network 50.1.1.0 0.0.0.255</span> <span style="font-family:courier new;"><br />no auto-summary</span><br /><br />[Note: the difference in the EIGRP configs isn't a mistake. The lab routers are running two different images, one of which has auto-summary disabled by default. The other has it enabled by default, so I had to explicitly turn it off.]<br /><br />This is a pretty standard GRE configuration that is used all the time to make a virtual point-to-point circuit across any other network. I'm intentionally leaving out the MTU complications for now.<br /><br />Here's the interface configuration for ASA1:<br /><br /><span style="font-family:courier new;">interface Ethernet0/2</span><br /><span style="font-family:courier new;"> description link to R4</span><br /> <span style="font-family:courier new;">nameif inside</span> <span style="font-family:courier new;"><br />security-level 100</span> <span style="font-family:courier new;"><br />ip address 1.1.1.1 255.255.255.0</span><br /> <span style="font-family:courier new;">!</span> <span style="font-family:courier new;"><br />interface Ethernet0/1</span><br /> <span style="font-family:courier new;">description link to ASA2 representing 3rd party network</span><br /> <span style="font-family:courier new;">nameif outside</span><br /> <span style="font-family:courier new;">security-level 0</span><br /> <span style="font-family:courier new;">ip address 100.1.1.1 255.255.255.0</span><br /><br />and here's the same configuration from ASA2:<br /><br /><span style="font-family:courier new;">interface Ethernet0/2</span><br /> <span style="font-family:courier new;">description link to R5</span><br /> <span style="font-family:courier new;">nameif inside</span><br /> <span style="font-family:courier new;">security-level 100</span> <span style="font-family:courier new;"><br />ip address 2.2.2.1 255.255.255.0</span><br /> <span style="font-family:courier new;">!</span> <span style="font-family:courier new;"><br />interface Ethernet0/1</span> <span style="font-family:courier new;"><br />description link to ASA1 representing 3rd party network<br /></span> <span style="font-family:courier new;">nameif outside</span> <span style="font-family:courier new;"><br />security-level 0</span> <span style="font-family:courier new;"><br />ip address 100.1.1.2 255.255.255.0</span><br /><br />Next, we need to configure IPSec on the ASAs. This is pretty similar to doing the same thing on a IOS router, with a couple of differences:<br /><span style="font-family:courier new;">crypto ipsec transform-set ESP_3DES esp-3des esp-sha-hmac</span> <span style="font-family:courier new;"><br />crypto ipsec security-association lifetime seconds 28800</span> <span style="font-family:courier new;"><br />crypto ipsec security-association lifetime kilobytes 4608000</span> <span style="font-family:courier new;"><br />crypto map P2P_CRYPTO_CM 10 match address R5_PHYSICAL</span> <span style="font-family:courier new;"><br />crypto map P2P_CRYPTO_CM 10 set peer 100.1.1.1</span> <span style="font-family:courier new;"><br />crypto map P2P_CRYPTO_CM 10 set transform-set ESP_3DES</span><br /> <span style="font-family:courier new;">crypto map P2P_CRYPTO_CM interface outside<br /></span> <span style="font-weight: bold; color: rgb(255, 0, 0);font-family:courier new;" >crypto isakmp enable outside</span><br /> <span style="font-family:courier new;">crypto isakmp policy 10</span> <span style="font-family:courier new;"><br />authentication pre-share<br /></span> <span style="font-family:courier new;">encryption 3des</span><br /> <span style="font-family:courier new;">hash sha</span><br /><span style="font-family:courier new;"> group 2</span><br /> <span style="font-family:courier new;">lifetime 86400</span> <span style="font-family:courier new;"><br />!<br /></span> <span style="font-family:courier new;">access-list R5_PHYSICAL extended permit ip host 2.2.2.5 host 1.1.1.4</span><br /><br />When I first set this up, I forgot the unfamiliar <span style="color: rgb(255, 0, 0);">crypto isakmp enable outside <span style="color: rgb(0, 0, 0);">command,</span></span><span style="font-weight: bold; color: rgb(255, 0, 0);"><span style="color: rgb(0, 0, 0);"><span style="font-weight: bold;"><span style="font-weight: bold;"> </span></span></span></span>and it took me a few minutes of looking at debugs to figure out why the ASA was dropping the IKE Phase 1 packets.<br /><br />The other part that's different from the IOS configuration is the presence of a "tunnel-group" that defines the tunnel type and the IKE pre-shared key:<br /><br /><span style="font-family:courier new;">tunnel-group 100.1.1.1 type ipsec-l2l</span> <span style="font-family:courier new;"><br />tunnel-group 100.1.1.1 ipsec-attributes<br /></span> <span style="font-family:courier new;">pre-shared-key *****</span><br /><br />I also needed to turn off NAT control so that the ASA wouldn't drop packets without a pre-defined NAT translation:<br /><br /><span style="font-family:courier new;">no nat-control</span><br /><br />The configuration on the other ASA is identical, except that the crypto ACL and peer addresses are reversed, just like they would be in an IOS configuration.
    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/2010/12/02/detecting-transparent-proxy-with" title="Detecting a Transparent Proxy with Wireshark/Tshark">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/2010/12/17/generate-dns-import-from-solarwinds" title="Generate DNS Import from Solarwinds Orion NCM">Next &rarr;</a>
      
    </div>
    <hr>
    
  </div>
  
  <div class="span4">
    <section>
      <h4>Published</h4>
      <div class="date"><span>06 December 2010</span></div>
           
    </section>
    
      <section>
        <h4>Categories</h4>
        
      </section>
         
             
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2015 Jay Swan
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    



  </body>
</html>

